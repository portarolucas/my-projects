{% extends "Layout.twig" %}

{% block style %}
<style>
    .notification {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 70%;
    }
</style>
{% endblock %}

{% block content %}
<div id="notification_block" class="notification" style="z-index: 999;display: none;">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="hideNotification()">
        <span aria-hidden="true">&times;</span>
    </button>
    <p></p>
</div>

<div class="box">
    <div class="box-header">
        <h2>Liste des particuliers</h2>
        <small>Possiblité de modifier ou de supprmier des particuliers</small>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered m-0">
            <thead>
                <tr>
                    <th style="width: 7%;">Nom </th>
                    <th style="width: 7%;">Prenom</th>
                    <th style="width: 7%;">Mail</th>
                    <th style="width: 7%;">Pays</th>
                    <th style="width: 15%;">Code postal</th>
                    <th style="width: 7%;">Ville </th>
                    <th style="width: 7%;">Adresse</th>
                    <th style="width: 15%;">Adresse compl</th>
                    <th style="width: 15%;">Telephone fixe</th>
                    <th style="width: 7%;">Telephone</th>
                    <th style="width: 15%;">Date de naissance </th>
                    <th style="width: 7%;">Pièce d'identité</th>
                </tr>
            </thead>

            <tbody>
                {% for utilisateur in utilisateurs %}
                <tr>
                    <td class="panel_nomparticulier"><span class="editable">{{ utilisateur.nom}}</span></td>
                    <td class="panel_prenomparticulier"><span class="editable">{{ utilisateur.prenom}}</span></td>
                    <td class="panel_mailparticulier"><span class="editable">{{ utilisateur.mail}}</span></td>
                    <td class="panel_paysparticulier"><span class="editable">{{ utilisateur.pays}}</span></td>
                    <td class="panel_code_postalparticulier"><span class="editable">{{ utilisateur.code_postal}}</span>
                    </td>
                    <td class="panel_villeparticulier"><span class="editable">{{ utilisateur.ville}}</span></td>
                    <td class="panel_adresseparticulier"><span class="editable">{{ utilisateur.adresse}}</span></td>
                    <td class="panel_comp_adresseparticulier"><span class="editable">{{
                            utilisateur.comp_adresse}}</span></td>
                    <td class="panel_telephone_fixeparticulier"><span class="editable">{{
                            utilisateur.telephone_fixe}}</span></td>
                    <td class="panel_telephone_mobileparticulier"><span class="editable">{{
                            utilisateur.telephone_mobile}}</span></td>
                    <td class="panel_date_naissanceparticulier"><span class="editable">{{
                            utilisateur.particulier.date_naissance}}</span></td>
                    <td class="panel_url_photocopie_piece_idparticulier"><span class="editable">{{
                            utilisateur.particulier.url_photocopie_piece_id}}</span></td>



                    <td class="panel_update">
                        <button type="button" class="btn btn-default btn-sm" data-toggle="modal"
                            data-target="#editUser_{{ utilisateur.id_utilisateur  }}">
                            <i class="far fa-edit"></i>
                        </button>
                        <div class="modal fade exampleModalClass" id="editUser_{{ utilisateur.id_utilisateur  }}"
                            tabindex="-1" role="dialog"
                            aria-labelledby="editUserLabel_{{ utilisateur.id_utilisateur }}">
                            <div class="modal-dialog" role="document">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <form ui-jp="parsley">
                                            <div class="box">
                                                <div class="box-header">
                                                    <div class="modal-header">
                                                        <h4 class="modal-title"
                                                            id="editUserLabel_{{ utilisateur.id_uitilisateur }}">
                                                            Modifier l'utilisateur
                                                        </h4>
                                                    </div>
                                                </div>
                                                <div class="box-body">
                                                    <div class="modal-body">
                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Adresse
                                                                mail</label>
                                                            <div class="col-sm-9">
                                                                <input type="text" value="{{ utilisateur.mail }}"
                                                                    class="form-control update_mailParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Pays :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text" value="{{ utilisateur.pays  }}"
                                                                    class="form-control update_paysParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Code postal
                                                                :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text" value="{{ utilisateur.code_postal }}"
                                                                    class="form-control update_code_postalParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Ville :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text" value="{{ utilisateur.ville  }}"
                                                                    class="form-control update_villeParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Adresse :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text" value="{{ utilisateur.adresse  }}"
                                                                    class="form-control update_adresseParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Complément
                                                                adresse
                                                                :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text"
                                                                    value="{{ utilisateur.comp_adresse  }}"
                                                                    class="form-control update_comp_adresseParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Téléphone fixe
                                                                :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text"
                                                                    value="{{ utilisateur.telephone_fixe  }}"
                                                                    class="form-control update_telephone_fixeParticulier">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="col-sm-3 form-control-label">Téléphone mobile
                                                                :</label>
                                                            <div class="col-sm-9">
                                                                <input type="text"
                                                                    value="{{ utilisateur.telephone_mobile  }}"
                                                                    class="form-control update_telephone_mobileParticulier">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="dker p-a text-right">
                                                        <button type="button" class="btn btn-default"
                                                            data-dismiss="modal">Annuler</button>
                                                        <button type="buttons" class="btn info"
                                                            onclick="particulierUpdate({{ utilisateur.id_utilisateur }}, this)">Modifier</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>

                    <td class="panel_delete">
                        <input type="button" value="Supprimer" class="btn btn-danger delCompteBtn" data-toggle="modal"
                            data-target="#particulierDelete{{ utilisateur.id_utilisateur }}">
                        <div class="modal fade" id="particulierDelete{{ utilisateur.id_utilisateur }}" tabindex="-1"
                            role="dialog" aria-labelledby="particulierDeleteLabel_{{ utilisateur.id_utilisateur }}"
                            aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title" id="deleteUserLabel_{{ utilisateur.id_utilisateur  }}">
                                            Supprimer un particulier:</h4>
                                    </div>
                                    <div class="modal-body">
                                        <p>Êtes-vous sûr de vouloir supprimer le particulier : {{ utilisateur.nom }} ?
                                        </p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-default"
                                            data-dismiss="modal">Annuler</button>
                                        <button type="button" class="btn btn-danger btn-ok"
                                            onclick="particulierDelete({{ utilisateur.id_utilisateur }}, this)">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block script %}
<script>

    function particulierDelete(id, leBtn) {
        let model = $(leBtn).parents().closest('.modal');
        let lineDelet = $(leBtn).parents().closest('tr');

        let http = new XMLHttpRequest();
        let params =
            'id_utilisateur=' + id;
        http.open('POST', '{{ path_for('particulierDelete') }}', true);

        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.onreadystatechange = function () {
            if (http.readyState == 4 && http.status == 200) {
                if (http.responseText == 'success') {
                    $(model).modal('hide');
                    showNotification('success', "Le particulier a bien été supprimé.");
                    $(lineDelet).hide('slow', function () {
                        $(lineDelet).remove();
                    });
                } else {
                    showNotification('danger', 'Erreur : ' + http.responseText);
                }
            }
        }
        http.send(params);
    }

    function particulierUpdate(id, leBtn) {
        let bodyModal = $(leBtn).parent().prev('.modal-body');
        let nom = $(bodyModal).find('.update_nomParticulier').val();
        let mail = $(bodyModal).find('.update_mailParticulier').val();
        let pays = $(bodyModal).find('.update_paysParticulier').val();
        let code_postal = $(bodyModal).find('.update_code_postalParticulier').val();
        let ville = $(bodyModal).find('.update_villeParticulier').val();
        let adresse = $(bodyModal).find('.update_adresseParticulier').val();
        let comp_adresse = $(bodyModal).find('.update_comp_adresseParticulier').val();
        let telephone_fixe = $(bodyModal).find('.update_telephone_fixeParticulier').val();
        let telephone_mobile = $(bodyModal).find('.update_telephone_mobileParticulier').val();



        if (id, mail, pays, code_postal, ville, adresse, comp_adresse, telephone_fixe, telephone_mobile) {
            let model = $(leBtn).parents().closest('.modal');
            let lineUpdate = $(leBtn).parents().closest('tr');
            let http = new XMLHttpRequest();

            let params =
                'id_utilisateur=' + id +
                '&mail=' + mail +
                '&pays=' + pays +
                '&code_postal=' + code_postal +
                '&ville=' + ville +
                '&adresse=' + adresse +
                '&comp_adresse=' + comp_adresse +
                '&telephone_fixe=' + telephone_fixe +
                '&telephone_mobile=' + telephone_mobile;
            http.open('POST', '{{ path_for('particulierUpdate') }}', true);

            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            http.onreadystatechange = function () {
                if (http.readyState == 4 && http.status == 200) {
                    console.log(http.responseText);
                    if (http.responseText == 'success') {
                        $(lineUpdate).find('.panel_mailparticulier').text(mail);
                        $(lineUpdate).find('.panel_paysparticulier').text(pays);
                        $(lineUpdate).find('.panel_code_postalparticulier').text(code_postal);
                        $(lineUpdate).find('.panel_villeparticulier').text(ville);
                        $(lineUpdate).find('.panel_adresseparticulier').text(adresse);
                        $(lineUpdate).find('.panel_comp_adresseparticulier').text(comp_adresse);
                        $(lineUpdate).find('.panel_telephone_fixeparticulier').text(telephone_fixe);
                        $(lineUpdate).find('.panel_telephone_mobileparticulier').text(telephone_mobile);

                        $(model).modal('hide');
                        showNotification('success', "Succès : Le particulier " + id + " a bien été modifié.");
                    } else {
                        showNotification('danger', 'Erreur : ', http.responseText);
                    }
                }
            }
            http.send(params);
        } else {
            alert("Une erreur est survenue : des champs sont manquants, introuvable, ou incomplet \n\rSi le problème persiste actualisez la page ou contacter l'particulier du site");
        }
    }
</script>
{% endblock %}